---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAreas, getTrailsForArea, getPOIsForArea } from '../../lib/data';

export function getStaticPaths() {
  return getAreas().map(area => ({ params: { slug: area.slug }, props: { area } }));
}

const { area } = Astro.props;
const trails = getTrailsForArea(area.slug);
const pois = getPOIsForArea(area.slug);

const trailsBySubarea = new Map<string, typeof trails>();
trails.forEach(t => {
  const key = t.subarea || '_none';
  if (!trailsBySubarea.has(key)) trailsBySubarea.set(key, []);
  trailsBySubarea.get(key)!.push(t);
});

const typeColors: Record<string, string> = {
  official: 'bg-forest-100 text-forest-800',
  unofficial: 'bg-trail-100 text-trail-800',
  greenway: 'bg-green-100 text-green-800',
  'fire-road': 'bg-amber-100 text-amber-800',
  connector: 'bg-stone-100 text-stone-600',
};

const difficultyColors: Record<string, string> = {
  easy: 'text-green-600',
  moderate: 'text-amber-600',
  difficult: 'text-red-600',
};
---

<BaseLayout title={area.name}>
  <nav class="text-sm text-stone-500 mb-4">
    <a href="/areas" class="hover:text-forest-700">Areas</a>
    <span class="mx-1">‚Ä∫</span>
    <span class="text-stone-800">{area.name}</span>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main content -->
    <div class="lg:col-span-2">
      <h1 class="font-display text-3xl font-bold text-stone-800 mb-2">{area.name}</h1>
      {area.operator && <p class="text-sm text-stone-500 mb-4">Managed by {area.operator}</p>}
      <p class="text-stone-700 leading-relaxed mb-8">{area.description}</p>

      <!-- Area map -->
      <div id="area-map" class="w-full h-64 rounded-xl border border-stone-200 mb-8 z-0" 
           data-center={JSON.stringify(area.center)} data-zoom={area.defaultZoom}></div>

      <!-- Trails by sub-area -->
      {area.subareas?.map(sub => {
        const subTrails = trailsBySubarea.get(sub.slug) || [];
        return (
          <div class="mb-8">
            <h2 class="font-display text-xl font-bold text-stone-800 mb-1">{sub.name}</h2>
            <p class="text-stone-600 text-sm mb-4">{sub.description}</p>
            
            {sub.trailheads?.length > 0 && (
              <div class="mb-4">
                {sub.trailheads.map(th => (
                  <div class="flex items-start gap-2 text-sm text-stone-600 mb-1">
                    <span>üÖøÔ∏è</span>
                    <div>
                      <span class="font-medium">{th.name}</span>
                      {th.notes && <span class="text-stone-400"> ‚Äî {th.notes}</span>}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {subTrails.length > 0 && (
              <div class="space-y-2">
                {subTrails.map(trail => (
                  <div class="bg-white border border-stone-200 rounded-lg p-4 hover:border-forest-300 transition-colors">
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <h3 class="font-medium text-stone-800">{trail.name}</h3>
                        <div class="flex items-center gap-3 mt-1 text-xs text-stone-500">
                          <span class={`px-1.5 py-0.5 rounded text-[10px] font-medium ${typeColors[trail.type] || ''}`}>{trail.type}</span>
                          <span>{trail.distance_miles} mi</span>
                          {trail.difficulty && <span class={difficultyColors[trail.difficulty]}>{trail.difficulty}</span>}
                          <span>{trail.loop ? 'loop' : 'out & back'}</span>
                          {trail.blaze && <span>blaze: {trail.blaze}</span>}
                        </div>
                      </div>
                    </div>
                    <p class="text-sm text-stone-600 mt-2">{trail.description}</p>
                    {trail.history && (
                      <div class="bg-trail-50 border border-trail-200 rounded-md p-3 mt-3">
                        <p class="text-xs text-trail-700 font-semibold uppercase tracking-wider mb-1">History</p>
                        <p class="text-sm text-trail-800">{trail.history}</p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      })}

      <!-- Trails without sub-area -->
      {trailsBySubarea.has('_none') && (
        <div class="mb-8">
          <h2 class="font-display text-xl font-bold text-stone-800 mb-4">Other Trails</h2>
          <div class="space-y-2">
            {trailsBySubarea.get('_none')!.map(trail => (
              <div class="bg-white border border-stone-200 rounded-lg p-4">
                <h3 class="font-medium text-stone-800">{trail.name}</h3>
                <p class="text-sm text-stone-600 mt-1">{trail.description}</p>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <div class="bg-white border border-stone-200 rounded-xl p-5">
        <h3 class="font-display font-bold text-stone-800 mb-3">At a Glance</h3>
        <dl class="space-y-2 text-sm">
          <div class="flex justify-between">
            <dt class="text-stone-500">Trails</dt>
            <dd class="font-medium text-stone-800">{trails.length}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-stone-500">Total Miles</dt>
            <dd class="font-medium text-stone-800">{trails.reduce((s, t) => s + (t.distance_miles || 0), 0).toFixed(1)}</dd>
          </div>
          {area.subareas && (
            <div class="flex justify-between">
              <dt class="text-stone-500">Sections</dt>
              <dd class="font-medium text-stone-800">{area.subareas.length}</dd>
            </div>
          )}
          {pois.length > 0 && (
            <div class="flex justify-between">
              <dt class="text-stone-500">Points of Interest</dt>
              <dd class="font-medium text-stone-800">{pois.length}</dd>
            </div>
          )}
        </dl>
      </div>

      {pois.length > 0 && (
        <div class="bg-white border border-stone-200 rounded-xl p-5">
          <h3 class="font-display font-bold text-stone-800 mb-3">Points of Interest</h3>
          <div class="space-y-3">
            {pois.map(poi => (
              <div class="text-sm">
                <div class="font-medium text-stone-800">{poi.name}</div>
                <div class="text-stone-500 text-xs">{poi.type}</div>
              </div>
            ))}
          </div>
        </div>
      )}

      <a href="/map" class="block text-center bg-forest-600 hover:bg-forest-500 text-white rounded-lg py-2.5 text-sm font-medium transition-colors">
        View on Map ‚Üí
      </a>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const mapEl = document.getElementById('area-map');
    if (!mapEl || typeof L === 'undefined') return;
    const center = JSON.parse(mapEl.dataset.center);
    const zoom = parseInt(mapEl.dataset.zoom);
    const map = L.map(mapEl).setView(center, zoom);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '¬© OpenStreetMap contributors',
    }).addTo(map);
  });
</script>

---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getTrails, getTrail, getArea, getSegmentsForTrail, getJunctions } from '../../lib/data';

export function getStaticPaths() {
  return getTrails().map(trail => ({ params: { slug: trail.slug }, props: { trail } }));
}

const { trail } = Astro.props;
const segments = getSegmentsForTrail(trail);
const junctions = getJunctions();
const primaryArea = trail.areas?.[0] ? getArea(trail.areas[0]) : null;

const typeColors: Record<string, string> = {
  official: 'bg-forest-100 text-forest-800',
  unofficial: 'bg-trail-100 text-trail-800',
  greenway: 'bg-green-100 text-green-800',
  'fire-road': 'bg-amber-100 text-amber-800',
  connector: 'bg-stone-100 text-stone-600',
};

const difficultyColors: Record<string, string> = {
  easy: 'text-green-600',
  moderate: 'text-amber-600',
  difficult: 'text-red-600',
};

// Get junction names for notable junctions on this trail
const trailJunctionSlugs = new Set<string>();
segments.forEach(s => { trailJunctionSlugs.add(s.from); trailJunctionSlugs.add(s.to); });
const notableJunctions = junctions.filter(j => trailJunctionSlugs.has(j.slug) && j.name);
---

<BaseLayout title={trail.name}>
  <nav class="text-sm text-stone-500 mb-4">
    <a href="/trails" class="hover:text-forest-700">Trails</a>
    {primaryArea && (
      <>
        <span class="mx-1">›</span>
        <a href={`/areas/${primaryArea.slug}`} class="hover:text-forest-700">{primaryArea.name}</a>
      </>
    )}
    <span class="mx-1">›</span>
    <span class="text-stone-800">{trail.name}</span>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
      <span class={`inline-block px-2 py-0.5 text-xs font-medium rounded-full ${typeColors[trail.type] || 'bg-stone-100'} mb-3`}>{trail.type}</span>
      <h1 class="font-display text-3xl font-bold text-stone-800 mb-4">{trail.name}</h1>

      <div class="flex flex-wrap gap-4 text-sm text-stone-600 mb-6">
        {trail.distance_miles && <span class="font-medium">{trail.distance_miles} mi</span>}
        {trail.difficulty && <span class={difficultyColors[trail.difficulty]}>{trail.difficulty}</span>}
        <span>{trail.loop ? 'Loop' : 'Out & Back'}</span>
        {trail.blaze && <span>Blaze: {trail.blaze}</span>}
        {trail.elevation_gain_ft && <span>↑ {trail.elevation_gain_ft} ft</span>}
      </div>

      <p class="text-stone-700 leading-relaxed mb-8">{trail.description}</p>

      {trail.history && (
        <div class="bg-trail-50 border border-trail-200 rounded-lg p-5 mb-8">
          <h2 class="text-xs font-semibold text-trail-700 uppercase tracking-wider mb-2">History</h2>
          <p class="text-sm text-trail-800 leading-relaxed">{trail.history}</p>
        </div>
      )}

      {trail.notes && (
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-8">
          <h2 class="text-xs font-semibold text-amber-700 uppercase tracking-wider mb-2">Trail Notes</h2>
          <p class="text-sm text-amber-800">{trail.notes}</p>
        </div>
      )}

      <!-- Segments breakdown -->
      {segments.length > 0 && (
        <div class="mb-8">
          <h2 class="font-display text-xl font-bold text-stone-800 mb-4">Trail Segments</h2>
          <div class="space-y-2">
            {segments.map((seg, i) => {
              const fromJct = junctions.find(j => j.slug === seg.from);
              const toJct = junctions.find(j => j.slug === seg.to);
              return (
                <div class="bg-white border border-stone-200 rounded-lg p-3 flex items-center gap-3">
                  <span class="text-xs text-stone-400 font-mono w-6">{i + 1}</span>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm text-stone-700">
                      {fromJct?.name || seg.from} → {toJct?.name || seg.to}
                    </div>
                    <div class="flex gap-3 text-xs text-stone-500 mt-0.5">
                      {seg.distance_ft && <span>{(seg.distance_ft / 5280).toFixed(2)} mi</span>}
                      {seg.surface && <span>{seg.surface}</span>}
                      {seg.difficulty && <span>{seg.difficulty}</span>}
                      {seg.blaze && <span>blaze: {seg.blaze}</span>}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <div class="bg-white border border-stone-200 rounded-xl p-5">
        <h3 class="font-display font-bold text-stone-800 mb-3">Trail Info</h3>
        <dl class="space-y-2 text-sm">
          {trail.distance_miles && (
            <div class="flex justify-between">
              <dt class="text-stone-500">Distance</dt>
              <dd class="font-medium text-stone-800">{trail.distance_miles} mi</dd>
            </div>
          )}
          {trail.elevation_gain_ft && (
            <div class="flex justify-between">
              <dt class="text-stone-500">Elevation Gain</dt>
              <dd class="font-medium text-stone-800">{trail.elevation_gain_ft} ft</dd>
            </div>
          )}
          <div class="flex justify-between">
            <dt class="text-stone-500">Route Type</dt>
            <dd class="font-medium text-stone-800">{trail.loop ? 'Loop' : 'Out & Back'}</dd>
          </div>
          {trail.blaze && (
            <div class="flex justify-between">
              <dt class="text-stone-500">Blaze</dt>
              <dd class="font-medium text-stone-800">{trail.blaze}</dd>
            </div>
          )}
          {segments.length > 0 && (
            <div class="flex justify-between">
              <dt class="text-stone-500">Segments</dt>
              <dd class="font-medium text-stone-800">{segments.length}</dd>
            </div>
          )}
        </dl>
      </div>

      <!-- Areas -->
      {trail.areas?.length > 0 && (
        <div class="bg-white border border-stone-200 rounded-xl p-5">
          <h3 class="font-display font-bold text-stone-800 mb-3">Areas</h3>
          <div class="space-y-1">
            {trail.areas.map(slug => {
              const a = getArea(slug);
              return a ? (
                <a href={`/areas/${a.slug}`} class="block text-sm text-forest-700 hover:text-forest-900">{a.name}</a>
              ) : null;
            })}
          </div>
        </div>
      )}

      <!-- Notable junctions -->
      {notableJunctions.length > 0 && (
        <div class="bg-white border border-stone-200 rounded-xl p-5">
          <h3 class="font-display font-bold text-stone-800 mb-3">Key Junctions</h3>
          <div class="space-y-2">
            {notableJunctions.map(j => (
              <div class="text-sm">
                <div class="font-medium text-stone-800">{j.name}</div>
                {j.description && <p class="text-xs text-stone-500 mt-0.5">{j.description}</p>}
              </div>
            ))}
          </div>
        </div>
      )}

      <a href="/map" class="block text-center bg-forest-600 hover:bg-forest-500 text-white rounded-lg py-2.5 text-sm font-medium transition-colors">
        View on Map →
      </a>
    </div>
  </div>
</BaseLayout>

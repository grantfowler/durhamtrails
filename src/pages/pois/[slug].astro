---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getPOIs, getArea, getTrail } from '../../lib/data';

export function getStaticPaths() {
  return getPOIs().map(poi => ({ params: { slug: poi.slug }, props: { poi } }));
}

const { poi } = Astro.props;
const primaryArea = poi.areas?.[0] ? getArea(poi.areas[0]) : null;
const secondaryArea = poi.areas?.[1] ? getArea(poi.areas[1]) : null;
const linkedTrails = (poi.trails || []).map(slug => getTrail(slug)).filter(Boolean);

const typeIcons: Record<string, string> = {
  historic: 'ğŸ›ï¸', natural: 'ğŸŒ¿', bridge: 'ğŸŒ‰',
  campsite: 'â›º', overlook: 'ğŸ‘ï¸', ruins: 'ğŸ§±', water: 'ğŸ’§', sign: 'ğŸ“‹',
};

const typeLabels: Record<string, string> = {
  historic: 'Historic Site', natural: 'Natural Feature', bridge: 'Bridge/Crossing',
  campsite: 'Campsite', overlook: 'Overlook', ruins: 'Ruins', water: 'Water Feature', sign: 'Information',
};
---

<BaseLayout title={poi.name}>
  <nav class="text-sm text-stone-500 mb-4">
    {secondaryArea && (
      <>
        <a href={`/areas/${secondaryArea.slug}`} class="hover:text-forest-700">{secondaryArea.name}</a>
        <span class="mx-1">â€º</span>
      </>
    )}
    {primaryArea && !secondaryArea && (
      <>
        <a href={`/areas/${primaryArea.slug}`} class="hover:text-forest-700">{primaryArea.name}</a>
        <span class="mx-1">â€º</span>
      </>
    )}
    <span class="text-stone-800">{poi.name}</span>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl">{typeIcons[poi.type] || 'ğŸ“'}</span>
        <div>
          <h1 class="font-display text-3xl font-bold text-stone-800">{poi.name}</h1>
          <span class="text-sm text-stone-500">{typeLabels[poi.type] || poi.type}</span>
        </div>
      </div>

      <p class="text-stone-700 leading-relaxed mb-8">{poi.description}</p>

      {poi.history && (
        <div class="bg-trail-50 border border-trail-200 rounded-lg p-5 mb-8">
          <h2 class="text-xs font-semibold text-trail-700 uppercase tracking-wider mb-2">History</h2>
          <p class="text-sm text-trail-800 leading-relaxed">{poi.history}</p>
        </div>
      )}

      <!-- Mini map -->
      <div id="poi-map" class="h-64 rounded-lg border border-stone-200 mb-8"></div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <div class="bg-white border border-stone-200 rounded-xl p-5">
        <h3 class="font-display font-bold text-stone-800 mb-3">Details</h3>
        <dl class="space-y-2 text-sm">
          <div class="flex justify-between">
            <dt class="text-stone-500">Type</dt>
            <dd class="font-medium text-stone-800">{typeLabels[poi.type] || poi.type}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-stone-500">Coordinates</dt>
            <dd class="font-mono text-xs text-stone-800">{poi.lat.toFixed(5)}, {poi.lng.toFixed(5)}</dd>
          </div>
        </dl>
      </div>

      {linkedTrails.length > 0 && (
        <div class="bg-white border border-stone-200 rounded-xl p-5">
          <h3 class="font-display font-bold text-stone-800 mb-3">Nearby Trails</h3>
          <div class="space-y-1">
            {linkedTrails.map(trail => (
              <a href={`/trails/${trail!.slug}`} class="block text-sm text-forest-700 hover:text-forest-900">
                {trail!.name}
              </a>
            ))}
          </div>
        </div>
      )}

      {poi.areas?.length > 0 && (
        <div class="bg-white border border-stone-200 rounded-xl p-5">
          <h3 class="font-display font-bold text-stone-800 mb-3">Areas</h3>
          <div class="space-y-1">
            {poi.areas.map(slug => {
              const a = getArea(slug);
              return a ? (
                <a href={`/areas/${a.slug}`} class="block text-sm text-forest-700 hover:text-forest-900">{a.name}</a>
              ) : null;
            })}
          </div>
        </div>
      )}

      <a href="/map" class="block text-center bg-forest-600 hover:bg-forest-500 text-white rounded-lg py-2.5 text-sm font-medium transition-colors">
        View on Full Map â†’
      </a>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ lat: poi.lat, lng: poi.lng, name: poi.name, icon: typeIcons[poi.type] || 'ğŸ“' }}>
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof L === 'undefined') return;
    const map = L.map('poi-map').setView([lat, lng], 16);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Â© Esri',
    }).addTo(map);

    const markerIcon = L.divIcon({
      html: '<span class="text-2xl">' + icon + '</span>',
      className: 'poi-marker',
      iconSize: [28, 28],
      iconAnchor: [14, 14],
    });
    L.marker([lat, lng], { icon: markerIcon }).addTo(map).bindPopup(name);

    // Load trails overlay
    fetch('/trails.geojson')
      .then(r => r.json())
      .then(geojson => {
        L.geoJSON(geojson, {
          style: { color: '#e63946', weight: 2, opacity: 0.6 }
        }).addTo(map);
      }).catch(() => {});
  });
</script>

<style>
  .poi-marker { background: none !important; border: none !important; }
</style>
